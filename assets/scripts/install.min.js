function getParams(){var t=window.location.href,e=t.split("?");if(1===e.length)return{};for(var n=decodeURIComponent(e[1]).split("&"),r={},o=0;o<n.length;o++){var i=n[o].split("=");r[i[0]]=i[1]}return r}function getpagecontent(t,e){var n=t,r={page:"install"},o=$("main"),i=function(t){history.pushState(r,"install","install.php?step="+t.step+"&op="+t.op),pageTransition(t)},a={get_page_content:n,op:e};processAjax(o,a,i,"install.php")}function pageTransition(t){var e=$("#hidden_container"),n=e.find("#current_content");if(0===e.find("#next_content").length)return e.append('<div id="next_content"></div>'),renderSection(n,t),!0;var r=e.find("#next_content");renderSection(r,t),n.animate({"margin-left":"-100%",opacity:0},1e3,function(){var t=$(this).siblings("#next_content");t.attr("id","current_content"),t.after('<div id="next_content"></div>'),$(this).remove()})}function renderSection(t,e){var n='<div class="box"><div id="section_title"></div><div id="section_content"></div></div>';t.html(n),t.find("#section_content").html(e.content),t.find("#section_title").html(e.title)}function loadingDiv(t){t.css("position","relative"),0===t.find(".loadingDiv").length&&t.append("<div class='loadingDiv'></div>"),t.find(".loadingDiv").css("position","absolute").fadeIn()}function removeLoading(t){t.fadeIn(200),t.find(".loadingDiv").fadeOut(1e3).remove()}function progressbar(t,e,n){t.css("position","relative"),t.find(".progress_layer").remove(),t.append('<div class="progress_layer"></div>');var r=t.find(".progress_layer");0===r.find(".progressText_container").length&&r.append('<div class="progressText_container"><div class="text"></div><div class="progressBar_container"><div class="progressBar"></div><div class="progressBar_loading"></div></div>');var o=t.find(".text");o.html(n);var i=t.find(".progressBar_container"),a=i.width();i.children(".progressBar").css({width:e*a+"px"})}function remove_progressbar(t){t.find(".progress_layer").remove()}function modOperation(t,e){var n;for(n=0;n<t.length;++n)if("operation"===t[n].name){t[n].value=e;break}return t}function gonext(){var t=$(".section_content#operation").data("action"),e=$(".section_content#operation").data("next");return getpagecontent(e,t),!0}function process(t){var e=t.length>0?$(t[0].form):$(),n=(e.find('input[name="operation"]').val(),e.find('input[name="op"]').val(),e.serializeArray()),r=$("#operation");if(!checkform(e))return!1;var o=[{url:"php/router.php?controller=Db&action=testdb",operation:"db_info",data:n,text:"Connecting to database"},{url:"php/router.php?controller=Config&action=createConfig",operation:"do_conf",data:n,text:"Creating configuration file"},{url:"php/router.php?controller=Backup&action=backupDb",operation:"backup",data:n,text:"Backup files and database"},{url:"php/router.php?controller=App&action=install",operation:"install_db",data:n,text:"Installing application"},{url:"php/router.php?controller=Session&action=checkDb",operation:"checkDb",data:n,text:"Checking database integrity"}],i=function(){progressbar(r,1,"Installation complete"),setTimeout(function(){return remove_progressbar(r),gonext(),!0},1e3)};return recursive_ajax(o,r,o.length,i),!0}function recursive_ajax(t,e,n,r){var o=1-t.length/n;if(t.length>0){var i=modOperation(t[0].data,t[0].operation);jQuery.ajax({url:t[0].url,type:"post",data:i,async:!0,timeout:2e4,beforeSend:function(){progressbar(e,o,t[0].text)},success:function(i){var a=jQuery.parseJSON(i);return a.status?(progressbar(e,o,a.msg),t.shift(),setTimeout(function(){recursive_ajax(t,e,n,r)},1e3),void 0):(progressbar(e,o,a.msg),setTimeout(function(){return remove_progressbar(e),!0},3e3),!1)},error:function(t,n,r){progressbar(e,o,n),setTimeout(function(){return remove_progressbar(e),!0},3e3)}})}else void 0!==r&&r()}function first_load(){if(!loaded){var t=getParams();getpagecontent(t.step,t.op),loaded=!0}}function testEmailSettings(t){var e=t.length>0?$(t[0].form):$(),n=e.serializeArray();processAjax(e,n,!1,"php/router.php?controller=MailManager&action=send_test_email")}var step=0,next_step=1,loaded=!1;$(function(){first_load(),$("body").on("click",".start",function(t){t.preventDefault();var e=$(this).attr("data-op");$(".section_content#operation").data("action",e),gonext(e)}).on("click",".finish",function(t){t.preventDefault(),window.location="index.php"}).on("click","input[type='submit']",function(t){return t.preventDefault(),t.stopPropagation(),!$(this).hasClass("process_form")&&!$(this).hasClass("test_email_settings")&&void process($(this))}).on("click",".processform",function(t){t.preventDefault(),t.stopPropagation();var e=$(this).length>0?$($(this)[0].form):$(),n=(e.find('input[name="op"]').val(),e.attr("action"));if(!checkform(e))return!1;var r=function(t){t.status===!0&&gonext()};processForm(e,r,n)}).on("click",".test_email_settings",function(t){t.preventDefault(),testEmailSettings($(this))}).on("click",".admin_creation",function(t){t.preventDefault();var e=$(this).length>0?$($(this)[0].form):$(),n=e.find('input[name="op"]').val();if(!checkform(e))return!1;var r=function(t){t.status===!0&&getpagecontent(5,n)};processForm(e,r,"install.php")})});